<div class="viewDetailProductsMain">
  <div class="appLayoutHeader" *ngIf="loading">
    <div class="appLayoutHeaderText d-flex justify-content-between align-items-center p-2">
      <div class="d-flex gap-2 align-items-center">
        <button nbButton size="small"
                (click)="backToPrev()"
                nbTooltip="Back to previous page" nbTooltipPlacement="bottom"
                class="rounded-2 fw-semibold">
          <nb-icon icon="arrow-back-outline"></nb-icon>
        </button>
        <h5 class="fw-semibold m-0">Back to Products</h5>
      </div>
      <div>
        <button nbButton size="small"
                (click)="copySharedLink()"
                nbTooltip="Share the prodcut to your friends." nbTooltipPlacement="left"
                class=" rounded-2 fw-semibold bg-dark text-white w-100">
          <nb-icon icon="share-outline"></nb-icon>
        </button>
       </div>
    </div>
  </div>
  <div class="appLayoutBody">
    <div class="productViewDetails bg-white rounded-2">
      <div class="row m-0">
        <div class="col-sm-12 col-md-1 col-lg-1 col-xl-1">
          <img src="{{image.url}}" alt="preview"
               [ngClass]="previewImage === image.url ? 'border border-danger' : ''"
               class=" img-thumbnail img-fluid cursor-pointer-npk mt-3"
               (mouseover)="previewImgUrl(image.url)" *ngFor="let image of product.images">
        </div>
        <div class="col-sm-12 col-md-4 col-lg-4 col-xl-4 p-3">
          <div class="zoom-wrapper bg-white">
            <div class="zoom-container">
              <lib-ngx-image-zoom
                [thumbImage]="previewImage"
                [fullImage]="previewImage"
                [enableScrollZoom]="true"
                [enableLens]="true"
                [lensHeight]="150"
                [lensWidth]="150"
                [magnification]="1.2"
                [circularLens]="true"
                class="zoom-image"
              ></lib-ngx-image-zoom>
            </div>
          </div>
        </div>
        <div class="col-sm-12 col-md-7 col-lg-7 col-xl-7">
          <nb-card class="productViewDetailsCard border-0">
            <nb-card-body class="productViewDetailsCardBody">
              <div class="row">
                <div class="col-sm-12 col-md-8 col-lg-8 col-xl-8">
                  <div>
                    <h3 class="fw-bold mb-1">{{product?.name}}</h3>
                  </div>
                  <div class="mt-2">
                    <p class="text-2xl mb-1">
                      <span class="text-danger">{{product?.discount}}%</span>
                      <span class="productMrp ml-2 fw-semibold" style="font-family: system-ui,serif !important;">{{product?.discountedPrice | currency:'INR':'symbol-narrow':'1.0-0'}}</span>
                    </p>
                    <p class="fw-semibold m-0 mt-2 text-0xl text-black-50 text-decoration-line-through" style="font-family: system-ui,serif !important;">MRP: {{ product?.price | currency:'INR':'symbol-narrow':'1.0-0' }}</p>
                    <p class="productStockBanner productStockBannerOOS" *ngIf="product.remainingCount <= 0">Out of Stock</p>
                    <p class="productStockBanner productStockBannerLS" *ngIf="product.remainingCount > 0 && product.remainingCount < 50">Low Stock</p>
                  </div>
                </div>
                <div class="col-sm-12 col-md-4 col-lg-4 col-xl-4">
                  <div *ngIf="!showAction">
                    <button nbButton size="small"
                            nbTooltip="Add the product to cart." nbTooltipPlacement="bottom"
                            (click)="storeCartAndFav(product._id, product.cart, 'cart')"
                            class=" rounded-2 fw-semibold bg-dark text-white w-100"
                            *ngIf="product.remainingCount > 0">
                      {{ product?.cart ? 'Added' : 'Add' }} to Cart<nb-icon [icon]="product?.cart ? 'checkmark-outline' : 'shopping-cart-outline'"></nb-icon>
                    </button>
                      <button nbButton size="small"
                              (click)="notifyUserForProduct(product, product.notified)"
                              nbTooltip="Currently this product is not available. If you want to notify then click here." nbTooltipPlacement="bottom"
                              class=" rounded-2 fw-semibold bg-dark text-white w-100"
                              *ngIf="product.remainingCount < 1">
                        {{product.notified ? 'Notified' : 'Notify'}} <nb-icon [status]="product.notified? 'danger' : 'basic'"  [icon]="product.notified ? 'bell' : 'bell-outline'"></nb-icon>
                      </button>
                    <button nbButton size="small"
                            nbTooltip="Add the product to wishlist." nbTooltipPlacement="bottom"
                            (click)="storeCartAndFav(product._id, product.wishlist, 'wishlist')"
                            class=" rounded-2 fw-semibold bg-primary text-white w-100 mt-1">
                      {{ product?.wishlist ? 'Wish listed' : 'Wishlist' }} <nb-icon [icon]="product?.wishlist ? 'heart' : 'heart-outline'"></nb-icon>
                    </button>
                    <button nbButton size="small"
                            [disabled]="product.remainingCount <= 0"
                            [nbTooltip]="product.remainingCount <= 0 ? 'Once the product is in stock then you can buy the product.' : 'Buy now the product.'" nbTooltipPlacement="bottom"
                            class=" rounded-2 fw-semibold bg-success text-white w-100 mt-1">
                      Buy Now
                    </button>
                  </div>
                </div>
              </div>
              <div class="mt-3">
                <p-divider></p-divider>
                <div class="mt-2">
                  <p class="fw-semibold mb-1">Offer's Available</p>
                  <small>Inclusive all taxes</small>
                  <div>
                    <span class="fw-semibold small">EMI </span>
                    <span>starts at </span>
                    <span style="font-family: system-ui,serif !important;">{{ product?.emiStartsAt | currency:'INR':'symbol-narrow':'1.0-0' }}. </span>
                    <span>EMI Options Available </span>
                    <span class="fw-semibold small text-primary cursor-pointer-npk" (click)="viewEMI(productEMIDialog, product?.emiDetails)">View </span>
                  </div>
                  <div class="mt-3 row">
                    <div class="col-sm-12 col-md-4 col-lg-4 col-xl-4 mb-2">
                      <div class="card">
                        <div class="card-body">
                          <p class="fw-semibold mb-1">Cashback</p>
                          <small class=" m-0">Upto ₹389.00 cashback. when you pay with NPK Payments</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-sm-12 col-md-4 col-lg-4 col-xl-4 mb-2">
                      <div class="card">
                        <div class="card-body">
                          <p class="fw-semibold mb-1">No Cost EMI</p>
                          <small class=" m-0">Upto ₹725.80 EMI interest savings on select Credit Cards</small>
                        </div>
                      </div>
                    </div>
                    <div class="col-sm-12 col-md-4 col-lg-4 col-xl-4 mb-2">
                      <div class="card">
                        <div class="card-body">
                          <p class="fw-semibold mb-1">Dealer Offer</p>
                          <small class=" m-0">Get GST invoice and save up to 28% on business purchases.</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <p-divider></p-divider>
                <div class="row">
                  <div class="col-4">
                    <div class="card">
                      <div class="card-body">
                        <p class="m-0"><nb-icon icon="credit-card-outline" ></nb-icon></p>
                        <small class="m-0 small" style="font-size: 12px">Cash/Pay on Delivery</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="card">
                      <div class="card-body">
                        <p class="m-0"><nb-icon icon="car-outline" ></nb-icon></p>
                        <small class="m-0 small" style="font-size: 12px">Free/Fast Delivery</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="card">
                      <div class="card-body">
                        <p class="m-0"><nb-icon icon="refresh-outline" ></nb-icon></p>
                        <small class="m-0 small" style="font-size: 12px">7 Day's returnable</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </nb-card-body>
          </nb-card>
        </div>
      </div>
      <div class="row m-0">
        <p-divider></p-divider>
        <div class="col-sm-12 col-md-6 col-lg-3 col-xl-3">
          <p class="fw-semibold mb-1">Reviews</p>
          <div class="productSpecifications mt-3">
            <div class="d-flex gap-2">
              <div>
                4.5 <nb-icon *ngFor="let item of [].constructor(5); let i = index" icon="star-outline" class="text-warning"></nb-icon>
              </div>
              <p class="m-0 cursor-pointer-npk">91 Reviews</p>
            </div>
            <small>100+ bought in last month</small>
            <p-divider></p-divider>
            <div>
              <div>
                <nb-icon *ngFor="let item of [].constructor(5); let i = index" icon="star-outline" class="text-warning"></nb-icon> 4.5 Out of 5
              </div>
              <div class="productReviewProgressBar mt-3">
                <div class="d-flex align-items-center mb-2">5
                  <nb-icon icon="star" class="text-warning" style="margin-bottom: 12px; height: 12px"></nb-icon>
                  <nb-progress-bar class="ml-1 w-100" [displayValue]="true" [value]="product?.reviewCounts?.fiveStar || 40" [status]="'success'"></nb-progress-bar>
                </div>
                <div class="d-flex align-items-center mb-2">4
                  <nb-icon icon="star" class="text-warning" style="margin-bottom: 12px; height: 12px"></nb-icon>
                  <nb-progress-bar class="ml-1 w-100" [displayValue]="true" [value]="product?.reviewCounts?.fiveStar || 18" [status]="'success'"></nb-progress-bar>
                </div>
                <div class="d-flex align-items-center mb-2">3
                  <nb-icon icon="star" class="text-warning" style="margin-bottom: 12px; height: 12px"></nb-icon>
                  <nb-progress-bar class="ml-1 w-100" [displayValue]="true" [value]="product?.reviewCounts?.fiveStar || 73" [status]="'success'"></nb-progress-bar>
                </div>
                <div class="d-flex align-items-center mb-2">2
                  <nb-icon icon="star" class="text-warning" style="margin-bottom: 12px; height: 12px"></nb-icon>
                  <nb-progress-bar class="ml-1 w-100" [displayValue]="true" [value]="product?.reviewCounts?.fiveStar || 28" [status]="'success'"></nb-progress-bar>
                </div>
                <div class="d-flex align-items-center mb-2">1
                  <nb-icon icon="star" class="text-warning" style="margin-bottom: 12px; height: 12px"></nb-icon>
                  <nb-progress-bar class="ml-1 w-100" [displayValue]="true" [value]="product?.reviewCounts?.fiveStar || 4" [status]="'success'"></nb-progress-bar>
                </div>
               </div>
            </div>
          </div>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-9 col-xl-9">
          <p class="fw-semibold mb-1">About this item</p>
          <small class="text-muted small">{{product?.description}}</small>
          <div class="productSpecifications mt-3">
            <table class="table table-bordered table-hover table-responsive">
              <tbody class="">
                <tr *ngFor="let key of Object.keys(product?.specifications || {}); let i = index">
                  <th>{{key}}</th>
                  <th class="fw-normal">{{product?.specifications[key]}}</th>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #productEMIDialog let-data let-ref="dialogRef" id="productEMIDialog">
  <nb-card class="globalDialogBox">
    <nb-card-header class="d-flex justify-content-between">
      <h5 class="m-0 fw-semibold">EMI</h5>
      <nb-icon class="cursor-pointer-npk" icon="close-outline" pack="eva" (click)="ref.close()"></nb-icon>
    </nb-card-header>
    <nb-card-body class="globalDialogBoxCardBody">
      <div class="">
        <table class="table table-bordered table-hover table-responsive">
          <thead class="">
            <tr class="">
              <th>Tenure (Months)</th>
              <th>EMI (₹/month)</th>
              <th>Total Payable (₹)</th>
              <th>Interest Amount</th>
              <th>Principal</th>
            </tr>
          </thead>
          <tbody>
            @for (emi of emiDetails;track emi.month) {
              <tr>
                <td>{{emi.month}}</td>
                <td>{{emi.monthlyEmi}}</td>
                <td>{{emi.totalPayable}}</td>
                <td>{{emi.interestAmount}}</td>
                <td>{{emi.principal}}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>
